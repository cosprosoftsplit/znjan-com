---
import Page from '@/layouts/Page.astro';
import Hero from '@/components/sections/Hero.astro';
import ScrollReveal from '@/components/ui/ScrollReveal.astro';
import Card from '@/components/ui/Card.astro';
import Badge from '@/components/ui/Badge.astro';
import { LANGUAGES, getLocalizedUrl, getLocalized } from '@/lib/i18n';
import type { Language } from '@/lib/i18n';
import { getTranslations } from '@/lib/translations';
import { generateHubHreflangLinks } from '@/lib/seo';
import { canonicalUrl } from '@/lib/utils';
import { getCollection } from 'astro:content';

export function getStaticPaths() {
  return LANGUAGES.map((lang) => ({ params: { lang } }));
}

const lang = Astro.params.lang as Language;
const translations = getTranslations(lang);
const hreflangLinks = generateHubHreflangLinks('activities');

const allActivities = await getCollection('activities');
const activities = allActivities.sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return a.data.order - b.data.order;
});

const categoryLabels: Record<string, Record<Language, string>> = {
  'water-sports': { en: 'Water Sports', hr: 'Vodeni sportovi', de: 'Wassersport', it: 'Sport acquatici' },
  'beach-sports': { en: 'Beach Sports', hr: 'Sportovi na pla≈æi', de: 'Strandsport', it: 'Sport da spiaggia' },
  fitness: { en: 'Fitness', hr: 'Fitness', de: 'Fitness', it: 'Fitness' },
  relaxation: { en: 'Relaxation', hr: 'Opu≈°tanje', de: 'Entspannung', it: 'Relax' },
  tours: { en: 'Tours', hr: 'Ture', de: 'Touren', it: 'Tour' },
  other: { en: 'Other', hr: 'Ostalo', de: 'Sonstiges', it: 'Altro' },
};

const difficultyLabels: Record<string, Record<Language, string>> = {
  easy: { en: 'Easy', hr: 'Lako', de: 'Leicht', it: 'Facile' },
  moderate: { en: 'Moderate', hr: 'Umjereno', de: 'Mittel', it: 'Moderato' },
  hard: { en: 'Hard', hr: 'Te≈°ko', de: 'Schwer', it: 'Difficile' },
};

// Group activities by category
const categories = [...new Set(activities.map((a) => a.data.category))];
const grouped = categories.map((cat) => ({
  category: cat,
  label: categoryLabels[cat]?.[lang] || cat,
  items: activities.filter((a) => a.data.category === cat),
}));

const activityIcons: Record<string, string> = {
  swimming: 'üèä',
  paddleboarding: 'üèÑ',
  'beach-volleyball': 'üèê',
  cycling: 'üö¥',
  kayaking: 'üõ∂',
  snorkeling: 'ü§ø',
};
---

<Page
  title={translations['activities.title']}
  description={translations['activities.subtitle']}
  lang={lang}
  translations={translations}
  canonicalUrl={canonicalUrl(getLocalizedUrl(lang, 'activities'))}
  hreflangLinks={hreflangLinks}
>
  <Hero
    title={translations['activities.title']}
    subtitle={translations['activities.subtitle']}
  />

  <section class="container-page section-breathe-lg">
    {activities.length > 0 ? (
      <div class="space-y-16">
        {grouped.map((group, gi) => (
          <div>
            <ScrollReveal animation="fade-up" delay={gi * 80}>
              <h2 class="text-2xl md:text-3xl font-display font-semibold text-ocean-800 tracking-tight flex items-center gap-3">
                {group.label}
                <span class="text-sm font-sans font-normal text-stone/50">({group.items.length})</span>
              </h2>
              <div class="mt-1 h-0.5 w-16 bg-coral-400 rounded-full"></div>
            </ScrollReveal>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {group.items.map((activity, i) => (
                <ScrollReveal animation="fade-up" delay={i * 60}>
                  <Card href={getLocalizedUrl(lang, 'activities', activity.data.slug[lang])}>
                    <div class="p-6">
                      <div class="flex items-center gap-3 mb-3">
                        <span class="text-2xl">{activityIcons[activity.data.id] || 'üèñÔ∏è'}</span>
                        <div class="flex items-center gap-2">
                          {activity.data.difficulty && (
                            <Badge variant="sand">{difficultyLabels[activity.data.difficulty]?.[lang]}</Badge>
                          )}
                        </div>
                      </div>
                      <h3 class="text-lg font-semibold text-ocean-700">
                        {getLocalized(activity.data.title, lang)}
                      </h3>
                      <p class="mt-2 text-sm text-stone line-clamp-3">
                        {activity.data.shortDescription
                          ? getLocalized(activity.data.shortDescription, lang)
                          : getLocalized(activity.data.description, lang)}
                      </p>
                      <div class="mt-4 flex items-center gap-3 text-xs text-stone/70">
                        {activity.data.duration && (
                          <span>{translations['activities.duration']}: {getLocalized(activity.data.duration, lang)}</span>
                        )}
                        {activity.data.priceRange && (
                          <span>{activity.data.priceRange}</span>
                        )}
                      </div>
                    </div>
                  </Card>
                </ScrollReveal>
              ))}
            </div>
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-16">
        <p class="text-lg text-stone">
          {lang === 'hr' ? 'Aktivnosti dolaze uskoro!' :
           lang === 'de' ? 'Aktivit√§ten kommen bald!' :
           lang === 'it' ? 'Le attivit√† arriveranno presto!' :
           'Activities coming soon!'}
        </p>
      </div>
    )}
  </section>
</Page>
