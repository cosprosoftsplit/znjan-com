---
import Place from '@/layouts/Place.astro';
import Badge from '@/components/ui/Badge.astro';
import Button from '@/components/ui/Button.astro';
import InstagramEmbed from '@/components/widgets/InstagramEmbed.astro';
import { LANGUAGES, getLocalized, getHreflangLinks } from '@/lib/i18n';
import type { Language } from '@/lib/i18n';
import { getTranslations } from '@/lib/translations';
import { canonicalUrl } from '@/lib/utils';
import { buildPlaceSchema, buildBreadcrumbSchema } from '@/lib/seo';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPlaces = await getCollection('places');
  const paths = [];

  for (const place of allPlaces) {
    for (const lang of LANGUAGES) {
      paths.push({
        params: { lang, slug: place.data.slug[lang] },
        props: { place, lang },
      });
    }
  }

  return paths;
}

const { place, lang } = Astro.props as {
  place: Awaited<ReturnType<typeof getCollection<'places'>>>[number];
  lang: Language;
};

const translations = getTranslations(lang);
const title = getLocalized(place.data.title, lang);
const description = getLocalized(place.data.description, lang);
const shortDescription = place.data.shortDescription
  ? getLocalized(place.data.shortDescription, lang)
  : undefined;

const hreflangLinks = getHreflangLinks('places', place.data.slug);

const categoryToSchemaType: Record<string, 'Restaurant' | 'BarOrPub' | 'CafeOrCoffeeShop' | 'Store' | 'TouristAttraction'> = {
  restaurant: 'Restaurant',
  bar: 'BarOrPub',
  'beach-club': 'TouristAttraction',
  cafe: 'CafeOrCoffeeShop',
  shop: 'Store',
  hotel: 'TouristAttraction',
  other: 'TouristAttraction',
};

const structuredData = [
  buildPlaceSchema({
    type: categoryToSchemaType[place.data.category] || 'TouristAttraction',
    name: title,
    description,
    url: `https://znjan.com/${lang}/places/${place.data.slug[lang]}/`,
    slug: place.data.slug.en,
    coordinates: place.data.coordinates,
    address: place.data.address,
    phone: place.data.phone,
    priceRange: place.data.priceRange,
  }),
  buildBreadcrumbSchema([
    { name: translations['nav.home'], url: `https://znjan.com/${lang}/` },
    { name: translations['nav.places'], url: `https://znjan.com/${lang}/places/` },
    { name: title, url: `https://znjan.com/${lang}/places/${place.data.slug[lang]}/` },
  ]),
];

const tagLabels: Record<string, Record<Language, string>> = {
  'beach-club': { en: 'Beach Club', hr: 'Beach Club', de: 'Beach Club', it: 'Beach Club' },
  'beach-bar': { en: 'Beach Bar', hr: 'Beach Bar', de: 'Strandbar', it: 'Bar sulla spiaggia' },
  cocktails: { en: 'Cocktails', hr: 'Kokteli', de: 'Cocktails', it: 'Cocktail' },
  'sea-view': { en: 'Sea View', hr: 'Pogled na more', de: 'Meerblick', it: 'Vista mare' },
  lounge: { en: 'Lounge', hr: 'Lounge', de: 'Lounge', it: 'Lounge' },
  sunset: { en: 'Sunset', hr: 'Zalazak sunca', de: 'Sonnenuntergang', it: 'Tramonto' },
  luxury: { en: 'Luxury', hr: 'Luksuz', de: 'Luxus', it: 'Lusso' },
  dj: { en: 'DJ', hr: 'DJ', de: 'DJ', it: 'DJ' },
  vip: { en: 'VIP', hr: 'VIP', de: 'VIP', it: 'VIP' },
  restaurant: { en: 'Restaurant', hr: 'Restoran', de: 'Restaurant', it: 'Ristorante' },
  italian: { en: 'Italian', hr: 'Talijanski', de: 'Italienisch', it: 'Italiano' },
  pizza: { en: 'Pizza', hr: 'Pizza', de: 'Pizza', it: 'Pizza' },
  wine: { en: 'Wine', hr: 'Vino', de: 'Wein', it: 'Vino' },
  mediterranean: { en: 'Mediterranean', hr: 'Mediteranski', de: 'Mediterran', it: 'Mediterraneo' },
  sushi: { en: 'Sushi', hr: 'Sushi', de: 'Sushi', it: 'Sushi' },
  'fine-dining': { en: 'Fine Dining', hr: 'Fine Dining', de: 'Gehobene Küche', it: 'Alta cucina' },
  breakfast: { en: 'Breakfast', hr: 'Doručak', de: 'Frühstück', it: 'Colazione' },
  'all-day-dining': { en: 'All-Day Dining', hr: 'Cijeli dan', de: 'Ganztägig', it: 'Tutto il giorno' },
  cafe: { en: 'Café', hr: 'Kafić', de: 'Café', it: 'Caffè' },
  music: { en: 'Music', hr: 'Glazba', de: 'Musik', it: 'Musica' },
  promenade: { en: 'Promenade', hr: 'Šetnica', de: 'Promenade', it: 'Lungomare' },
  waterfront: { en: 'Waterfront', hr: 'Na obali', de: 'Am Wasser', it: 'Lungomare' },
  reservations: { en: 'Reservations', hr: 'Rezervacije', de: 'Reservierungen', it: 'Prenotazioni' },
  cabanas: { en: 'Cabanas', hr: 'Kabane', de: 'Cabanas', it: 'Cabane' },
};
---

<Place
  title={title}
  description={shortDescription || description}
  lang={lang}
  translations={translations}
  canonicalUrl={canonicalUrl(`/${lang}/places/${place.data.slug[lang]}/`)}
  hreflangLinks={hreflangLinks}
  structuredData={structuredData}
  category={place.data.category}
  address={place.data.address}
  phone={place.data.phone}
  website={place.data.website}
  priceRange={place.data.priceRange}
  hours={place.data.hours}
>
  <div class="prose-beach">
    {place.data.status === 'coming-soon' && (
      <div class="mb-6 p-4 bg-coral-50 border border-coral-200 rounded-lg">
        <p class="text-sm font-medium text-coral-600">
          {lang === 'hr' ? `Otvaranje: ${place.data.openingDate || 'uskoro'}` :
           lang === 'de' ? `Eröffnung: ${place.data.openingDate || 'demnächst'}` :
           lang === 'it' ? `Apertura: ${place.data.openingDate || 'prossimamente'}` :
           `Opening: ${place.data.openingDate || 'coming soon'}`}
        </p>
      </div>
    )}

    <p class="text-warm-600 leading-relaxed">{description}</p>

    {place.data.starRating && (
      <div class="mt-6 flex items-center gap-3">
        <span class="text-xl text-sand-500">{'★'.repeat(place.data.starRating)}{'☆'.repeat(5 - place.data.starRating)}</span>
        <span class="text-sm text-warm-500">
          {place.data.starRating}-{lang === 'hr' ? 'zvjezdica' : lang === 'de' ? 'Sterne' : lang === 'it' ? 'stelle' : 'star'} {place.data.category === 'hotel' ? (lang === 'hr' ? 'hotel' : lang === 'de' ? 'Hotel' : lang === 'it' ? 'hotel' : 'hotel') : ''}
        </span>
        {place.data.roomCount && (
          <span class="text-sm text-warm-400">
            · {place.data.roomCount} {lang === 'hr' ? 'soba' : lang === 'de' ? 'Zimmer' : lang === 'it' ? 'camere' : 'rooms'}
          </span>
        )}
      </div>
    )}

    {place.data.tags.length > 0 && (
      <div class="mt-6">
        <h2 class="text-lg font-semibold text-ocean-700 mb-3">
          {lang === 'hr' ? 'Oznake' : lang === 'de' ? 'Tags' : lang === 'it' ? 'Tag' : 'Tags'}
        </h2>
        <div class="flex flex-wrap gap-2">
          {place.data.tags.map((tag: string) => (
            <Badge variant="ocean">
              {tagLabels[tag]?.[lang] || tag.replace(/-/g, ' ')}
            </Badge>
          ))}
        </div>
      </div>
    )}

    {place.data.cuisine && place.data.cuisine.length > 0 && (
      <div class="mt-6">
        <h2 class="text-lg font-semibold text-ocean-700 mb-3">
          {lang === 'hr' ? 'Kuhinja' : lang === 'de' ? 'Küche' : lang === 'it' ? 'Cucina' : 'Cuisine'}
        </h2>
        <div class="flex flex-wrap gap-2">
          {place.data.cuisine.map((c: string) => (
            <Badge variant="sand">{c.charAt(0).toUpperCase() + c.slice(1)}</Badge>
          ))}
        </div>
      </div>
    )}

    {place.data.email && (
      <div class="mt-6 p-4 bg-ocean-50 rounded-lg">
        <p class="text-sm text-ocean-700">
          <strong>{lang === 'hr' ? 'E-pošta' : lang === 'de' ? 'E-Mail' : lang === 'it' ? 'E-mail' : 'Email'}:</strong>{' '}
          <a href={`mailto:${place.data.email}`} class="text-ocean-600 hover:underline">{place.data.email}</a>
        </p>
      </div>
    )}

    {place.data.instagram && (
      <div class="mt-8">
        <h2 class="text-lg font-semibold text-ocean-700 mb-3">
          {lang === 'hr' ? 'Pratite na Instagramu' : lang === 'de' ? 'Auf Instagram folgen' : lang === 'it' ? 'Segui su Instagram' : 'Follow on Instagram'}
        </h2>
        <a
          href={`https://www.instagram.com/${place.data.instagram}/`}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium text-sm hover:from-purple-600 hover:to-pink-600 transition-all"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/>
          </svg>
          @{place.data.instagram}
        </a>
      </div>
    )}
  </div>
</Place>
