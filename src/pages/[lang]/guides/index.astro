---
import Page from '@/layouts/Page.astro';
import Hero from '@/components/sections/Hero.astro';
import ScrollReveal from '@/components/ui/ScrollReveal.astro';
import Card from '@/components/ui/Card.astro';
import Badge from '@/components/ui/Badge.astro';
import { LANGUAGES, getLocalizedUrl } from '@/lib/i18n';
import type { Language } from '@/lib/i18n';
import { getTranslations } from '@/lib/translations';
import { generateHubHreflangLinks } from '@/lib/seo';
import { canonicalUrl, formatDate } from '@/lib/utils';
import { getCollection } from 'astro:content';

export function getStaticPaths() {
  return LANGUAGES.map((lang) => ({ params: { lang } }));
}

const lang = Astro.params.lang as Language;
const translations = getTranslations(lang);
const hreflangLinks = generateHubHreflangLinks('guides');

const allGuides = await getCollection('guides', ({ data }) => data.lang === lang);
const guides = allGuides.sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime());
const firstGuide = guides[0];
const remainingGuides = guides.slice(1);

const clusterGradients: Record<string, string> = {
  'getting-started': 'linear-gradient(135deg, #0077B6 0%, #023e8a 40%, #0096c7 100%)',
  'food-drink': 'linear-gradient(135deg, #e07d6a 0%, #f4a261 100%)',
  'activities': 'linear-gradient(135deg, #2d8a9b 0%, #0077B6 100%)',
  'accommodation': 'linear-gradient(135deg, #023e8a 0%, #0077B6 50%, #48cae4 100%)',
};
---

<Page
  title={translations['guides.title']}
  description={translations['guides.subtitle']}
  lang={lang}
  translations={translations}
  canonicalUrl={canonicalUrl(`/${lang}/${translations['nav.guides'] === 'Vodiči' ? 'vodici' : lang === 'de' ? 'reisefuehrer' : lang === 'it' ? 'guide' : 'guides'}/`)}
  hreflangLinks={hreflangLinks}
>
  <Hero
    title={translations['guides.title']}
    subtitle={translations['guides.subtitle']}
  />

  <section class="container-page py-16">
    {guides.length > 0 ? (
      <>
        {/* First guide — full-width hero card */}
        {firstGuide && (
          <ScrollReveal class="mb-12">
            <a
              href={getLocalizedUrl(lang, 'guides', firstGuide.data.slugs[lang])}
              class="group relative block rounded-2xl overflow-hidden aspect-[21/9]"
            >
              <div
                class="absolute inset-0 transition-transform duration-500 group-hover:scale-105"
                style={`background: ${clusterGradients[firstGuide.data.cluster] || clusterGradients['getting-started']}`}
              >
                <svg class="absolute inset-0 w-full h-full opacity-10" preserveAspectRatio="none" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg">
                  <path d="M0 100 Q100 40 200 100 T400 100 T600 100 T800 100" fill="none" stroke="white" stroke-width="2.5" />
                  <path d="M0 140 Q100 80 200 140 T400 140 T600 140 T800 140" fill="none" stroke="white" stroke-width="1.5" />
                </svg>
              </div>
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent"></div>

              <div class="absolute top-5 left-5">
                {firstGuide.data.cluster && (
                  <span class="inline-block px-3 py-1 text-xs font-semibold uppercase tracking-wider bg-white/90 text-ocean-700 rounded-full">
                    {firstGuide.data.cluster}
                  </span>
                )}
              </div>

              <div class="absolute bottom-0 left-0 right-0 p-6 md:p-8">
                <h2 class="text-2xl md:text-3xl lg:text-4xl font-display font-semibold text-white">
                  {firstGuide.data.title[lang]}
                </h2>
                <p class="mt-3 text-sm md:text-base text-white/80 max-w-2xl line-clamp-2">
                  {firstGuide.data.description[lang]}
                </p>
                <div class="mt-4 flex items-center gap-3 text-xs text-white/60">
                  <span>{formatDate(firstGuide.data.publishedAt, lang)}</span>
                  {firstGuide.data.readingTime && (
                    <span>{firstGuide.data.readingTime} {translations['guides.minuteRead']}</span>
                  )}
                </div>
              </div>
            </a>
          </ScrollReveal>
        )}

        {/* Remaining guides — 2-col grid */}
        {remainingGuides.length > 0 && (
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {remainingGuides.map((guide, i) => (
              <ScrollReveal animation="fade-up" delay={i * 80}>
                <Card href={getLocalizedUrl(lang, 'guides', guide.data.slugs[lang])}>
                  <div class="p-6">
                    {guide.data.cluster && (
                      <Badge variant="ocean">{guide.data.cluster}</Badge>
                    )}
                    <h2 class="mt-3 text-lg font-semibold text-ocean-700 line-clamp-2">
                      {guide.data.title[lang]}
                    </h2>
                    <p class="mt-2 text-sm text-stone line-clamp-3">
                      {guide.data.description[lang]}
                    </p>
                    <div class="mt-4 flex items-center gap-3 text-xs text-stone/70">
                      <span>{formatDate(guide.data.publishedAt, lang)}</span>
                      {guide.data.readingTime && (
                        <span>{guide.data.readingTime} {translations['guides.minuteRead']}</span>
                      )}
                    </div>
                  </div>
                </Card>
              </ScrollReveal>
            ))}
          </div>
        )}
      </>
    ) : (
      <div class="text-center py-16">
        <p class="text-lg text-stone">
          {lang === 'hr' ? 'Vodiči dolaze uskoro! Vraćajte se po najnovije informacije o plaži Žnjan.' :
           lang === 'de' ? 'Reiseführer kommen bald! Schauen Sie zurück für die neuesten Informationen über den Strand Žnjan.' :
           lang === 'it' ? 'Le guide arriveranno presto! Torna per le ultime informazioni sulla spiaggia di Žnjan.' :
           'Guides coming soon! Check back for the latest information about Znjan Beach.'}
        </p>
      </div>
    )}
  </section>
</Page>
