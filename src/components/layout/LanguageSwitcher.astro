---
import type { Language } from '@/lib/i18n';
import { LANGUAGES, LANGUAGE_NAMES, LANGUAGE_FLAGS } from '@/lib/i18n';

interface Props {
  lang: Language;
  /** Optional: pass alternate URLs for each language to link to equivalent page */
  alternates?: Partial<Record<Language, string>>;
}

const { lang, alternates } = Astro.props;

function getUrl(targetLang: Language): string {
  if (alternates?.[targetLang]) {
    return alternates[targetLang]!;
  }
  // Replace the language prefix in the current URL path
  const currentPath = Astro.url.pathname;
  const pathWithoutLang = currentPath.replace(/^\/[a-z]{2}\//, '/');
  return `/${targetLang}${pathWithoutLang}`;
}
---

<div class="relative" data-lang-switcher>
  <button
    class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium text-cream/80 hover:text-white focus:outline-none focus:ring-2 focus:ring-cream/30 focus:ring-offset-2 focus:ring-offset-ocean-800 transition-colors duration-200"
    aria-label="Select language"
    aria-expanded="false"
    aria-haspopup="true"
    data-lang-trigger
  >
    <span class="text-base">{LANGUAGE_FLAGS[lang]}</span>
    <span class="uppercase">{lang}</span>
    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <div
    class="absolute right-0 top-full mt-1 hidden bg-ocean-800 rounded-lg shadow-lg border border-ocean-700/50 py-1 min-w-[160px] z-50"
    role="menu"
    data-lang-menu
  >
    {LANGUAGES.map((targetLang) => (
      <a
        href={getUrl(targetLang)}
        class:list={[
          'flex items-center gap-2 px-4 py-2 text-sm transition-colors duration-200',
          targetLang === lang
            ? 'text-white bg-ocean-700/50 font-medium'
            : 'text-cream/70 hover:bg-ocean-700/30 hover:text-white',
        ]}
        role="menuitem"
        hreflang={targetLang}
      >
        <span class="text-base">{LANGUAGE_FLAGS[targetLang]}</span>
        <span>{LANGUAGE_NAMES[targetLang]}</span>
      </a>
    ))}
  </div>
</div>

<script>
  document.querySelectorAll('[data-lang-switcher]').forEach((switcher) => {
    const trigger = switcher.querySelector('[data-lang-trigger]') as HTMLButtonElement;
    const menu = switcher.querySelector('[data-lang-menu]') as HTMLElement;

    if (!trigger || !menu) return;

    trigger.addEventListener('click', () => {
      const isOpen = menu.classList.contains('hidden');
      menu.classList.toggle('hidden');
      trigger.setAttribute('aria-expanded', String(isOpen));
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      if (!switcher.contains(e.target as Node)) {
        menu.classList.add('hidden');
        trigger.setAttribute('aria-expanded', 'false');
      }
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !menu.classList.contains('hidden')) {
        menu.classList.add('hidden');
        trigger.setAttribute('aria-expanded', 'false');
        trigger.focus();
      }
    });
  });
</script>
