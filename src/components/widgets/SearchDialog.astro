---
import type { Language } from '@/lib/i18n';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;

const labels: Record<Language, { search: string; placeholder: string; noResults: string; close: string }> = {
  en: { search: 'Search', placeholder: 'Search Znjan Beach...', noResults: 'No results found', close: 'Close' },
  hr: { search: 'Pretraži', placeholder: 'Pretraži plažu Žnjan...', noResults: 'Nema rezultata', close: 'Zatvori' },
  de: { search: 'Suchen', placeholder: 'Strand Žnjan durchsuchen...', noResults: 'Keine Ergebnisse', close: 'Schließen' },
  it: { search: 'Cerca', placeholder: 'Cerca spiaggia Žnjan...', noResults: 'Nessun risultato', close: 'Chiudi' },
};

const l = labels[lang];
---

<!-- Search trigger button -->
<button
  id="search-trigger"
  type="button"
  class="inline-flex items-center gap-2 px-3 py-1.5 text-sm text-cream/70 hover:text-white rounded-lg transition-colors duration-200"
  aria-label={l.search}
>
  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
  </svg>
  <span class="hidden sm:inline">{l.search}</span>
  <kbd class="hidden md:inline-flex items-center px-1.5 py-0.5 text-xs text-cream/50 bg-ocean-700/50 rounded border border-ocean-700">/</kbd>
</button>

<!-- Search dialog -->
<dialog
  id="search-dialog"
  class="fixed inset-0 z-50 m-0 p-0 w-full h-full max-w-full max-h-full bg-transparent backdrop:bg-black/40"
>
  <div class="flex items-start justify-center pt-[10vh] px-4 min-h-full">
    <div class="w-full max-w-xl bg-white rounded-xl shadow-2xl border border-sand-200 overflow-hidden">
      <!-- Search header -->
      <div class="flex items-center gap-3 px-4 border-b border-sand-200">
        <svg class="w-5 h-5 text-stone shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          id="search-input"
          type="search"
          placeholder={l.placeholder}
          class="flex-1 py-3 text-base text-warm-700 bg-transparent border-0 outline-none placeholder:text-stone/50"
          autocomplete="off"
        />
        <button
          id="search-close"
          type="button"
          class="text-xs text-stone bg-sand-100 rounded px-2 py-1 hover:bg-sand-200 transition-colors duration-200"
        >
          Esc
        </button>
      </div>

      <!-- Search results -->
      <div id="search-results" class="max-h-[50vh] overflow-y-auto p-2">
        <div id="search-empty" class="hidden p-8 text-center text-stone text-sm">
          {l.noResults}
        </div>
      </div>
    </div>
  </div>
</dialog>

<link rel="stylesheet" href="/pagefind/pagefind-ui.css" />

<script define:vars={{ lang }}>
  let pagefind = null;

  async function loadPagefind() {
    if (pagefind) return pagefind;
    try {
      pagefind = await import('/pagefind/pagefind.js');
      await pagefind.init();
      return pagefind;
    } catch (e) {
      console.warn('Pagefind not available:', e);
      return null;
    }
  }

  const trigger = document.getElementById('search-trigger');
  const dialog = document.getElementById('search-dialog');
  const input = document.getElementById('search-input');
  const results = document.getElementById('search-results');
  const empty = document.getElementById('search-empty');
  const closeBtn = document.getElementById('search-close');

  function openSearch() {
    dialog.showModal();
    input.value = '';
    results.innerHTML = '';
    empty.classList.add('hidden');
    results.appendChild(empty);
    setTimeout(() => input.focus(), 50);
    loadPagefind();
  }

  function closeSearch() {
    dialog.close();
  }

  trigger.addEventListener('click', openSearch);
  closeBtn.addEventListener('click', closeSearch);

  dialog.addEventListener('click', (e) => {
    if (e.target === dialog) closeSearch();
  });

  // "/" shortcut to open search
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && !dialog.open && !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName)) {
      e.preventDefault();
      openSearch();
    }
    if (e.key === 'Escape' && dialog.open) {
      closeSearch();
    }
  });

  let debounceTimer;
  input.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      const query = input.value.trim();
      if (!query) {
        results.innerHTML = '';
        empty.classList.add('hidden');
        results.appendChild(empty);
        return;
      }

      const pf = await loadPagefind();
      if (!pf) return;

      const search = await pf.search(query, {
        filters: {},
      });

      results.innerHTML = '';
      results.appendChild(empty);

      if (search.results.length === 0) {
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');
      const shown = search.results.slice(0, 8);
      for (const result of shown) {
        const data = await result.data();
        // Filter to current language pages
        if (!data.url.startsWith('/' + lang + '/')) continue;

        const a = document.createElement('a');
        a.href = data.url;
        a.className = 'block px-4 py-3 rounded-lg hover:bg-sand-50 transition-colors duration-200';
        a.innerHTML = `
          <div class="text-sm font-medium text-ocean-700">${data.meta?.title || data.url}</div>
          ${data.excerpt ? `<div class="mt-1 text-xs text-stone line-clamp-2">${data.excerpt}</div>` : ''}
        `;
        a.addEventListener('click', () => closeSearch());
        results.appendChild(a);
      }

      if (results.children.length <= 1) {
        empty.classList.remove('hidden');
      }
    }, 200);
  });
</script>
