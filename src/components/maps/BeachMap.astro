---
import type { Language } from '@/lib/i18n';

interface MapMarker {
  lat: number;
  lng: number;
  title: string;
  description?: string;
  category: string;
  href?: string;
}

interface Props {
  lang: Language;
  markers?: MapMarker[];
  zoom?: number;
  height?: string;
}

const {
  lang,
  markers = [],
  zoom = 15,
  height = '450px',
} = Astro.props;

const mapLabels: Record<Language, Record<string, string>> = {
  en: { viewDetails: 'View details', zoomIn: 'Zoom in', zoomOut: 'Zoom out' },
  hr: { viewDetails: 'Pogledaj detalje', zoomIn: 'PoveÄ‡aj', zoomOut: 'Smanji' },
  de: { viewDetails: 'Details ansehen', zoomIn: 'VergrÃ¶ÃŸern', zoomOut: 'Verkleinern' },
  it: { viewDetails: 'Vedi dettagli', zoomIn: 'Ingrandisci', zoomOut: 'Riduci' },
};

const categoryIcons: Record<string, string> = {
  restaurant: 'ğŸ½ï¸',
  bar: 'ğŸ¹',
  'beach-club': 'ğŸ–ï¸',
  cafe: 'â˜•',
  shop: 'ğŸ›ï¸',
  hotel: 'ğŸ¨',
  activity: 'ğŸ„',
  'beach-area': 'ğŸï¸',
  other: 'ğŸ“',
};

const labels = mapLabels[lang];
---

<div
  id="beach-map"
  class="rounded-xl overflow-hidden border border-warm-200 shadow-sm"
  style={`height: ${height}`}
  role="application"
  aria-label={lang === 'hr' ? 'Interaktivna karta plaÅ¾e Å½njan' : lang === 'de' ? 'Interaktive Karte Strand Å½njan' : lang === 'it' ? 'Mappa interattiva spiaggia Å½njan' : 'Interactive Znjan Beach Map'}
>
  <div class="flex items-center justify-center h-full bg-ocean-50 text-warm-500 text-sm">
    <svg class="w-5 h-5 animate-spin mr-2" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
    </svg>
    {lang === 'hr' ? 'UÄitavanje karte...' : lang === 'de' ? 'Karte wird geladen...' : lang === 'it' ? 'Caricamento mappa...' : 'Loading map...'}
  </div>
</div>

<script define:vars={{ markers, zoom, categoryIcons, labels }}>
  // Load Leaflet CSS
  const cssLink = document.createElement('link');
  cssLink.rel = 'stylesheet';
  cssLink.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
  cssLink.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
  cssLink.crossOrigin = '';
  document.head.appendChild(cssLink);

  // Load Leaflet JS
  const script = document.createElement('script');
  script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
  script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
  script.crossOrigin = '';
  script.onload = initMap;
  document.head.appendChild(script);

  function initMap() {
    const mapEl = document.getElementById('beach-map');
    if (!mapEl || !window.L) return;

    // Clear loading state
    mapEl.innerHTML = '';

    // Center on Znjan Beach
    const center = [43.5025, 16.4875];
    const map = window.L.map('beach-map', {
      center: center,
      zoom: zoom,
      scrollWheelZoom: false,
      zoomControl: true,
    });

    // OpenStreetMap tiles
    window.L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    }).addTo(map);

    // Add markers
    if (markers && markers.length > 0) {
      const bounds = [];
      markers.forEach(function(m) {
        const icon = categoryIcons[m.category] || 'ğŸ“';
        const markerIcon = window.L.divIcon({
          html: '<span style="font-size:1.5rem;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))">' + icon + '</span>',
          className: 'bg-transparent border-0',
          iconSize: [30, 30],
          iconAnchor: [15, 15],
        });

        const marker = window.L.marker([m.lat, m.lng], { icon: markerIcon }).addTo(map);

        let popup = '<div style="min-width:160px"><strong>' + m.title + '</strong>';
        if (m.description) {
          popup += '<br><span style="font-size:0.85em;color:#666">' + m.description + '</span>';
        }
        if (m.href) {
          popup += '<br><a href="' + m.href + '" style="color:#0369a1;font-size:0.85em">' + labels.viewDetails + ' â†’</a>';
        }
        popup += '</div>';
        marker.bindPopup(popup);

        bounds.push([m.lat, m.lng]);
      });

      if (bounds.length > 1) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    // Enable scroll zoom on focus
    mapEl.addEventListener('click', function() {
      map.scrollWheelZoom.enable();
    });
    mapEl.addEventListener('mouseleave', function() {
      map.scrollWheelZoom.disable();
    });
  }
</script>
