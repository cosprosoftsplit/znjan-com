---
import Page from '@/layouts/Page.astro';
import HeroFull from '@/components/sections/HeroFull.astro';
import BeachAreasGrid from '@/components/sections/BeachAreasGrid.astro';
import StorySection from '@/components/sections/StorySection.astro';
import PlacesShowcase from '@/components/sections/PlacesShowcase.astro';
import StatsAnimated from '@/components/sections/StatsAnimated.astro';
import ActivitiesStrip from '@/components/sections/ActivitiesStrip.astro';
import BeachMap from '@/components/maps/BeachMap.astro';
import InstagramGrid from '@/components/widgets/InstagramGrid.astro';
import ScrollReveal from '@/components/ui/ScrollReveal.astro';
import { LANGUAGES, getLocalizedUrl, getLocalized } from '@/lib/i18n';
import type { Language } from '@/lib/i18n';
import { getTranslations } from '@/lib/translations';
import { generateHomeHreflangLinks, buildBeachSchema, buildOrganizationSchema, buildFAQSchema } from '@/lib/seo';
import { canonicalUrl } from '@/lib/utils';
import { getCollection } from 'astro:content';

export function getStaticPaths() {
  return LANGUAGES.map((lang) => ({ params: { lang } }));
}

const lang = Astro.params.lang as Language;
const translations = getTranslations(lang);
const hreflangLinks = generateHomeHreflangLinks();

const allPlaces = await getCollection('places');
const allAreas = await getCollection('beach-areas');
const allActivities = await getCollection('activities');
const allFaqs = await getCollection('faq');

// Map markers
const mapMarkers = [
  ...allAreas.map((area) => ({
    lat: area.data.coordinates.lat,
    lng: area.data.coordinates.lng,
    title: getLocalized(area.data.title, lang),
    category: 'beach-area',
    href: getLocalizedUrl(lang, 'beach-areas', area.data.slug[lang]),
  })),
  ...allPlaces.filter((p) => p.data.status !== 'coming-soon').map((place) => ({
    lat: place.data.coordinates.lat,
    lng: place.data.coordinates.lng,
    title: getLocalized(place.data.title, lang),
    category: place.data.category,
    href: getLocalizedUrl(lang, 'places', place.data.slug[lang]),
  })),
];

// FAQs ‚Äî max 6 on homepage
const faqs = allFaqs.sort((a, b) => a.data.order - b.data.order).slice(0, 6);
const faqSchemaItems = faqs.map((f) => ({
  question: getLocalized(f.data.question, lang),
  answer: getLocalized(f.data.answer, lang),
}));

// Beach areas data for grid
const sortedAreas = allAreas.sort((a, b) => a.data.order - b.data.order);
const areaVariants: ('ocean' | 'adriatic' | 'sunset' | 'coral' | 'sand')[] = ['ocean', 'adriatic', 'sunset', 'coral', 'sand'];
// Beach area images (from znjan.hr)
const areaImages: Record<string, string> = {
  'main-beach': '/images/hero/znjan-aerial-1.jpg',
  'sports-zone': '/images/hero/znjan-aerial-2.jpg',
  'kids-area': '/images/hero/znjan-aerial-3.jpg',
  'amphitheater': '/images/hero/znjan-aerial-4.jpg',
  'promenade': '/images/hero/znjan-still-2.jpg',
};
const areasData = sortedAreas.map((area, i) => ({
  title: getLocalized(area.data.title, lang),
  href: getLocalizedUrl(lang, 'beach-areas', area.data.slug[lang]),
  facilitiesCount: area.data.facilities.length,
  variant: areaVariants[i % areaVariants.length] as 'ocean' | 'sunset' | 'sand' | 'coral' | 'adriatic',
  image: areaImages[area.data.id],
}));

// Places for showcase
const categoryLabels: Record<string, Record<Language, string>> = {
  restaurant: { en: 'Restaurant', hr: 'Restoran', de: 'Restaurant', it: 'Ristorante' },
  bar: { en: 'Bar', hr: 'Bar', de: 'Bar', it: 'Bar' },
  'beach-club': { en: 'Beach Club', hr: 'Beach Club', de: 'Beach Club', it: 'Beach Club' },
  cafe: { en: 'Caf√©', hr: 'Kafiƒá', de: 'Caf√©', it: 'Caff√®' },
  hotel: { en: 'Hotel', hr: 'Hotel', de: 'Hotel', it: 'Hotel' },
  other: { en: 'Other', hr: 'Ostalo', de: 'Sonstiges', it: 'Altro' },
};
const placeVariants: ('ocean' | 'adriatic' | 'sunset' | 'coral' | 'sand')[] = ['adriatic', 'sunset', 'coral', 'ocean', 'sand', 'adriatic', 'coral'];
const sortedPlaces = allPlaces
  .filter((p) => p.data.status !== 'coming-soon')
  .sort((a, b) => {
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    return a.data.order - b.data.order;
  });
// Place images + credits (from business websites)
const placeImages: Record<string, { src: string; credit: string }> = {
  'taboo-beach-club': { src: '/images/places/taboo-daybeds.jpg', credit: 'Photo: Taboo Beach Club' },
  'mistral-beach-club': { src: '/images/places/mistral-lounge.jpg', credit: 'Photo: Mistral Beach Club' },
  'central-beach': { src: '/images/places/central-beach-indoor.webp', credit: 'Photo: Central Beach Split' },
  'mimi-italian-clubino': { src: '/images/places/mimi-main.webp', credit: 'Photo: MIMI / F Group' },
  'gal-split': { src: '/images/places/gal-terrace.jpg', credit: 'Photo: GAL Split' },
};
const placesData = sortedPlaces.map((place, i) => ({
  title: getLocalized(place.data.title, lang),
  description: place.data.shortDescription
    ? getLocalized(place.data.shortDescription, lang)
    : getLocalized(place.data.description, lang),
  category: place.data.category,
  categoryLabel: categoryLabels[place.data.category]?.[lang] || place.data.category,
  href: getLocalizedUrl(lang, 'places', place.data.slug[lang]),
  variant: placeVariants[i % placeVariants.length] as 'ocean' | 'sunset' | 'sand' | 'coral' | 'adriatic',
  image: placeImages[place.data.id]?.src,
  credit: placeImages[place.data.id]?.credit,
}));

// Activities for strip
const activityIcons: Record<string, string> = {
  swimming: 'üèä',
  paddleboarding: 'üèÑ',
  'beach-volleyball': 'üèê',
  cycling: 'üö¥',
  kayaking: 'üõ∂',
  snorkeling: 'ü§ø',
};
const sortedActivities = allActivities.sort((a, b) => a.data.order - b.data.order);
const activitiesData = sortedActivities.map((activity) => ({
  title: getLocalized(activity.data.title, lang),
  description: activity.data.shortDescription
    ? getLocalized(activity.data.shortDescription, lang)
    : getLocalized(activity.data.description, lang),
  icon: activityIcons[activity.data.id] || 'üèñÔ∏è',
  href: getLocalizedUrl(lang, 'activities', activity.data.slug[lang]),
}));

// Story blocks ‚Äî with images from znjan.hr and business sites
const storyBlocks = [
  {
    eyebrow: translations['home.storyEyebrow1'],
    title: translations['home.storyTitle1'],
    text: translations['home.storyText1'],
    variant: 'ocean' as const,
    image: '/images/story/znjan-hero-render-1.png',
    credit: 'Photo: znjan.hr',
  },
  {
    eyebrow: translations['home.storyEyebrow2'],
    title: translations['home.storyTitle2'],
    text: translations['home.storyText2'],
    variant: 'sunset' as const,
    image: '/images/places/gal-cocktails.jpg',
    credit: 'Photo: GAL Split',
  },
  {
    eyebrow: translations['home.storyEyebrow3'],
    title: translations['home.storyTitle3'],
    text: translations['home.storyText3'],
    variant: 'adriatic' as const,
    image: '/images/beach-areas/znjan-diving-platform.jpg',
    credit: 'Photo: znjan.hr',
  },
];
---

<Page
  title={translations['seo.homeTitle']}
  description={translations['seo.homeDescription']}
  lang={lang}
  translations={translations}
  canonicalUrl={canonicalUrl(`/${lang}/`)}
  hreflangLinks={hreflangLinks}
  structuredData={[buildBeachSchema(), buildOrganizationSchema(), buildFAQSchema(faqSchemaItems)]}
>
  <!-- 1. Cinematic Hero -->
  <HeroFull
    title={translations['home.heroTitle']}
    subtitle={translations['home.heroSubtitle']}
    ctaText={translations['home.readGuides']}
    ctaHref={getLocalizedUrl(lang, 'guides')}
    scrollText={translations['home.scrollDown']}
    heroImage="/images/hero/znjan-aerial-2.jpg"
  />

  <!-- Anchor for scroll indicator -->
  <div id="content"></div>

  <!-- 2. Beach Areas ‚Äî Asymmetric Grid -->
  <BeachAreasGrid
    eyebrow={translations['home.areasEyebrow']}
    title={translations['home.beachAreasTitle']}
    areas={areasData}
    facilitiesLabel={translations['home.facilitiesCount']}
  />

  <!-- 3. Story ‚Äî Zig-zag Split-screen -->
  <StorySection blocks={storyBlocks} />

  <!-- 4. Places ‚Äî Horizontal Scroll Showcase -->
  <PlacesShowcase
    eyebrow={translations['home.placesEyebrow']}
    title={translations['home.popularPlaces']}
    viewAllText={translations['common.viewAll']}
    viewAllHref={getLocalizedUrl(lang, 'places')}
    places={placesData}
  />

  <!-- 5. Stats ‚Äî Animated Counters -->
  <StatsAnimated
    stats={[
      { value: '‚Ç¨45', suffix: 'M', label: translations['home.statsInvestment'] },
      { value: '2', suffix: 'km+', label: translations['home.statsBeachLength'] },
      { value: '5', label: translations['home.statsBeachZones'] },
      { value: '11', label: translations['home.statsVenues'] },
    ]}
  />

  <!-- 6. Activities ‚Äî Icon Strip -->
  <ActivitiesStrip
    eyebrow={translations['home.activitiesEyebrow']}
    title={translations['activities.title']}
    activities={activitiesData}
  />

  <!-- 7. Map ‚Äî Full Width -->
  <section class="section-breathe">
    <div class="container-page mb-6">
      <ScrollReveal>
        <span class="eyebrow">{translations['home.mapEyebrow']}</span>
        <h2 class="mt-3 text-3xl md:text-4xl lg:text-5xl font-display font-semibold text-ocean-800 tracking-tight">
          {translations['home.mapTitle']}
        </h2>
      </ScrollReveal>
    </div>
    <ScrollReveal animation="fade-in">
      <BeachMap lang={lang} markers={[]} zoom={15} fullWidth={true} />
    </ScrollReveal>
  </section>

  <!-- 8. Instagram ‚Äî Staggered -->
  <section class="container-page section-breathe">
    <ScrollReveal>
      <span class="eyebrow">{translations['home.instagramEyebrow']}</span>
    </ScrollReveal>
    <InstagramGrid
      title={lang === 'hr' ? '≈Ωnjan na Instagramu' : lang === 'de' ? '≈Ωnjan auf Instagram' : lang === 'it' ? '≈Ωnjan su Instagram' : '≈Ωnjan on Instagram'}
      subtitle={lang === 'hr' ? 'Pogledajte ≈°to vas ƒçeka na pla≈æi' : lang === 'de' ? 'Sehen Sie, was Sie am Strand erwartet' : lang === 'it' ? 'Scoprite cosa vi aspetta in spiaggia' : 'See what awaits you at the beach'}
      posts={[
        { url: 'https://www.instagram.com/p/DTfQp62jfeZ/', caption: 'Taboo Beach Club' },
        { url: 'https://www.instagram.com/p/DUqlKjEEtEF/', caption: 'Mistral Beach Club' },
        { url: 'https://www.instagram.com/p/DMyFWihzOYX/', caption: 'Mistral Beach Club' },
        { url: 'https://www.instagram.com/reel/DJQzkSZhcK7/', caption: 'Mistral Beach Club' },
      ]}
      columns={2}
      staggered={true}
    />
  </section>

  <!-- 9. FAQ ‚Äî Max 6 items -->
  <section class="container-page section-breathe-lg">
    <ScrollReveal>
      <h2 class="text-3xl md:text-4xl lg:text-5xl font-display font-semibold text-ocean-800 tracking-tight">
        {translations['home.thingsToKnow']}
      </h2>
    </ScrollReveal>
    <div class="mt-10 max-w-3xl space-y-4">
      {faqs.map((faq, i) => (
        <ScrollReveal animation="fade-up" delay={i * 60}>
          <details class="group bg-white rounded-xl border border-sand-200">
            <summary class="flex items-center justify-between px-6 py-5 cursor-pointer text-ocean-700 font-medium hover:bg-sand-50 transition-colors duration-200">
              <span class="text-base">{getLocalized(faq.data.question, lang)}</span>
              <svg class="w-5 h-5 shrink-0 ml-4 transition-transform duration-200 group-open:rotate-180 text-ocean-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="px-6 pb-5 text-stone leading-relaxed border-t border-sand-200 pt-4">
              {getLocalized(faq.data.answer, lang)}
            </div>
          </details>
        </ScrollReveal>
      ))}
    </div>
    <div class="mt-8">
      <a
        href={getLocalizedUrl(lang, 'guides')}
        class="inline-flex items-center gap-1 text-sm font-medium text-adriatic-400 hover:text-adriatic-500 transition-colors"
      >
        {translations['home.seeAllFaqs']}
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>
  </section>
</Page>
