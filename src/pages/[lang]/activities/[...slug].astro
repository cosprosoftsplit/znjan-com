---
import Page from '@/layouts/Page.astro';
import Badge from '@/components/ui/Badge.astro';
import Button from '@/components/ui/Button.astro';
import { LANGUAGES, getLocalized, getLocalizedUrl, getHreflangLinks } from '@/lib/i18n';
import type { Language } from '@/lib/i18n';
import { getTranslations } from '@/lib/translations';
import { canonicalUrl } from '@/lib/utils';
import { buildBreadcrumbSchema } from '@/lib/seo';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allActivities = await getCollection('activities');
  const paths = [];

  for (const activity of allActivities) {
    for (const lang of LANGUAGES) {
      paths.push({
        params: { lang, slug: activity.data.slug[lang] },
        props: { activity, lang },
      });
    }
  }

  return paths;
}

const { activity, lang } = Astro.props as {
  activity: Awaited<ReturnType<typeof getCollection<'activities'>>>[number];
  lang: Language;
};

const translations = getTranslations(lang);
const title = getLocalized(activity.data.title, lang);
const description = getLocalized(activity.data.description, lang);
const shortDescription = activity.data.shortDescription
  ? getLocalized(activity.data.shortDescription, lang)
  : undefined;

const hreflangLinks = getHreflangLinks('activities', activity.data.slug);

const structuredData = buildBreadcrumbSchema([
  { name: translations['nav.home'], url: `https://znjan.com/${lang}/` },
  { name: translations['nav.activities'], url: `https://znjan.com/${lang}/activities/` },
  { name: title, url: `https://znjan.com/${lang}/activities/${activity.data.slug[lang]}/` },
]);

const categoryLabels: Record<string, Record<Language, string>> = {
  'water-sports': { en: 'Water Sports', hr: 'Vodeni sportovi', de: 'Wassersport', it: 'Sport acquatici' },
  'beach-sports': { en: 'Beach Sports', hr: 'Sportovi na plaži', de: 'Strandsport', it: 'Sport da spiaggia' },
  fitness: { en: 'Fitness', hr: 'Fitness', de: 'Fitness', it: 'Fitness' },
  relaxation: { en: 'Relaxation', hr: 'Opuštanje', de: 'Entspannung', it: 'Relax' },
  tours: { en: 'Tours', hr: 'Ture', de: 'Touren', it: 'Tour' },
  other: { en: 'Other', hr: 'Ostalo', de: 'Sonstiges', it: 'Altro' },
};

const difficultyLabels: Record<string, Record<Language, string>> = {
  easy: { en: 'Easy', hr: 'Lako', de: 'Leicht', it: 'Facile' },
  moderate: { en: 'Moderate', hr: 'Umjereno', de: 'Mittel', it: 'Moderato' },
  hard: { en: 'Hard', hr: 'Teško', de: 'Schwer', it: 'Difficile' },
};

const seasonLabels: Record<string, Record<Language, string>> = {
  summer: { en: 'Summer only', hr: 'Samo ljeti', de: 'Nur im Sommer', it: 'Solo estate' },
  'year-round': { en: 'Year-round', hr: 'Cijele godine', de: 'Ganzjährig', it: 'Tutto l\'anno' },
  'spring-autumn': { en: 'Spring to Autumn', hr: 'Proljeće do jesen', de: 'Frühling bis Herbst', it: 'Primavera-Autunno' },
};
---

<Page
  title={title}
  description={shortDescription || description}
  lang={lang}
  translations={translations}
  canonicalUrl={canonicalUrl(`/${lang}/activities/${activity.data.slug[lang]}/`)}
  hreflangLinks={hreflangLinks}
  structuredData={[structuredData]}
>
  <!-- Breadcrumb -->
  <nav class="container-page pt-6" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2 text-sm text-stone">
      <li>
        <a href={`/${lang}/`} class="hover:text-adriatic-400 transition-colors">
          {translations['nav.home']}
        </a>
      </li>
      <li class="flex items-center gap-2">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href={getLocalizedUrl(lang, 'activities')} class="hover:text-adriatic-400 transition-colors">
          {translations['nav.activities']}
        </a>
      </li>
      <li class="flex items-center gap-2">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-warm-700 font-medium">{title}</span>
      </li>
    </ol>
  </nav>

  <!-- Activity Header -->
  <header class="container-page pt-8 pb-6">
    <div class="max-w-4xl">
      <div class="flex flex-wrap items-center gap-2 mb-4">
        <Badge variant="ocean">{categoryLabels[activity.data.category]?.[lang] || activity.data.category}</Badge>
        {activity.data.difficulty && (
          <Badge variant="sand">{difficultyLabels[activity.data.difficulty]?.[lang]}</Badge>
        )}
        <Badge variant="default">{seasonLabels[activity.data.season]?.[lang]}</Badge>
      </div>
      <h1 class="text-3xl md:text-4xl font-display font-semibold text-ocean-800 tracking-tight">
        {title}
      </h1>
    </div>
  </header>

  <!-- Activity Content -->
  <div class="container-page pb-16">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-5xl">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <div class="prose-beach">
          <p class="text-stone leading-relaxed text-lg">{description}</p>
        </div>

        {activity.data.beachAreas.length > 0 && (
          <div class="mt-8">
            <h2 class="text-lg font-semibold text-ocean-700 mb-3">
              {lang === 'hr' ? 'Dostupno na' : lang === 'de' ? 'Verfügbar an' : lang === 'it' ? 'Disponibile a' : 'Available at'}
            </h2>
            <div class="flex flex-wrap gap-2">
              {activity.data.beachAreas.map((area: string) => (
                <Badge variant="sand">{area.replace(/-/g, ' ')}</Badge>
              ))}
            </div>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <aside class="space-y-6">
        <div class="bg-white rounded-xl border border-sand-200 p-6">
          <h2 class="font-semibold text-ocean-700 mb-4">
            {lang === 'hr' ? 'Detalji' : lang === 'de' ? 'Details' : lang === 'it' ? 'Dettagli' : 'Details'}
          </h2>
          <dl class="space-y-3 text-sm">
            <div>
              <dt class="text-stone/70 font-medium">
                {lang === 'hr' ? 'Kategorija' : lang === 'de' ? 'Kategorie' : lang === 'it' ? 'Categoria' : 'Category'}
              </dt>
              <dd class="mt-0.5 text-warm-700">{categoryLabels[activity.data.category]?.[lang]}</dd>
            </div>
            {activity.data.difficulty && (
              <div>
                <dt class="text-stone/70 font-medium">
                  {lang === 'hr' ? 'Težina' : lang === 'de' ? 'Schwierigkeit' : lang === 'it' ? 'Difficoltà' : 'Difficulty'}
                </dt>
                <dd class="mt-0.5 text-warm-700">{difficultyLabels[activity.data.difficulty]?.[lang]}</dd>
              </div>
            )}
            {activity.data.duration && (
              <div>
                <dt class="text-stone/70 font-medium">{translations['activities.duration']}</dt>
                <dd class="mt-0.5 text-warm-700">{getLocalized(activity.data.duration, lang)}</dd>
              </div>
            )}
            {activity.data.priceRange && (
              <div>
                <dt class="text-stone/70 font-medium">
                  {lang === 'hr' ? 'Cijena' : lang === 'de' ? 'Preis' : lang === 'it' ? 'Prezzo' : 'Price'}
                </dt>
                <dd class="mt-0.5 text-warm-700">{activity.data.priceRange}</dd>
              </div>
            )}
            <div>
              <dt class="text-stone/70 font-medium">
                {lang === 'hr' ? 'Sezona' : lang === 'de' ? 'Saison' : lang === 'it' ? 'Stagione' : 'Season'}
              </dt>
              <dd class="mt-0.5 text-warm-700">{seasonLabels[activity.data.season]?.[lang]}</dd>
            </div>
          </dl>
        </div>

        <Button href={getLocalizedUrl(lang, 'activities')} variant="outline" class="w-full">
          {lang === 'hr' ? 'Sve aktivnosti' : lang === 'de' ? 'Alle Aktivitäten' : lang === 'it' ? 'Tutte le attività' : 'All Activities'}
        </Button>
      </aside>
    </div>
  </div>
</Page>
